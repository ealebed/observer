apiVersion: v1
kind: Namespace
metadata:
  name: observer
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: observer-ksa
  namespace: observer
  # If you use GKE Workload Identity with a GCP SA, uncomment and set:
  # annotations:
  #   iam.gke.io/gcp-service-account: observer-sa@your-project.iam.gserviceaccount.com
---
# RBAC: only needs EndpointSlice read (we don't fetch Pods)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: observer
rules:
- apiGroups: ["discovery.k8s.io"]
  resources: ["endpointslices"]
  verbs: ["get","list","watch"]
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get","list","watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: observer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: observer
subjects:
- kind: ServiceAccount
  name: observer-ksa
  namespace: observer
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: observer
  namespace: observer
spec:
  replicas: 1
  selector:
    matchLabels:
      app: observer
  template:
    metadata:
      labels:
        app: observer
    spec:
      serviceAccountName: observer-ksa
      securityContext:
        runAsNonRoot: true
      containers:
      - name: observer
        image: ealebed/observer:latest
        imagePullPolicy: IfNotPresent
        args:
          - --requeue-after=30s
        env:
          - name: PGHOST
            value: postgres.default.svc
          - name: PGPORT
            value: "5432"
          - name: PGUSER
            value: observer
          - name: PGPASSWORD
            valueFrom:
              secretKeyRef:
                name: apps-password
                key: pgdb-password
          - name: PGDATABASE
            value: infra
          - name: PGSSLMODE
            value: "require"
          - name: TABLE_NAME
            value: "public.test_server"
          - name: CLUSTER_NAME
            value: "gke-dev-01"
          - name: ENDPOINT_SELECTOR
            value: "kubernetes.io/service-name=my-service"
          - name: NAMESPACE
            value: "ssp-rtb"
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          # distroless:nonroot typically runs as 65532
          runAsUser: 65532
          runAsGroup: 65532
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
