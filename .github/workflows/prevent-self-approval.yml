name: Prevent self-approval on auto cherry-pick PRs

on:
  pull_request_review:
    types: [submitted]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

jobs:
  prevent-self-approval:
    # Only act when the review is APPROVED
    if: github.event.review.state == 'approved'
    runs-on: ubuntu-latest

    steps:
      - name: Dump event for debugging
        uses: actions/github-script@v7
        with:
          script: |
            core.info('Event name: ' + context.eventName);
            core.info('Review state: ' + (context.payload.review && context.payload.review.state));
            core.info('PR number: ' + (context.payload.pull_request && context.payload.pull_request.number));
            core.info('Labels: ' + JSON.stringify(context.payload.pull_request && context.payload.pull_request.labels || []));

      - name: Check and dismiss self-approval if needed
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const review = context.payload.review;

            if (!pr || !review) {
              core.info('No pull_request or review in payload, nothing to do.');
              return;
            }

            const labels = pr.labels || [];
            const marker = 'orig-author:';

            // Find label like "orig-author:<login>"
            const authorLabel = labels.find(l => typeof l.name === 'string' && l.name.startsWith(marker));
            if (!authorLabel) {
              core.info('No orig-author label on this PR. Skipping.');
              return;
            }

            const originalAuthor = authorLabel.name.substring(marker.length).trim();
            const reviewer = review.user && review.user.login ? review.user.login : '';

            core.info(`Original author from label: "${originalAuthor}", reviewer: "${reviewer}", state: "${review.state}"`);

            if (!originalAuthor || !reviewer) {
              core.info('Missing originalAuthor or reviewer, nothing to do.');
              return;
            }

            if (review.state.toLowerCase() !== 'approved') {
              core.info('Review is not APPROVED (maybe COMMENTED / CHANGES_REQUESTED). Nothing to do.');
              return;
            }

            if (reviewer.toLowerCase() !== originalAuthor.toLowerCase()) {
              core.info('Reviewer is not the original author. Nothing to do.');
              return;
            }

            core.info('Detected self-approval on an auto cherry-pick PR. Dismissing review...');

            await github.rest.pulls.dismissReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              review_id: review.id,
              message: 'Self-approval of an auto cherry-pick PR is not allowed. Review was automatically dismissed.'
            });

            core.info('Review dismissed successfully.');
